# PRISMA 文献筛选助手 v1.7 更新日志

## 新增功能

### 1. 关键词优先级机制 (解决"误杀"问题)

**问题描述**：用户反馈"在排除关键词筛选后会把包含关键词的文章误杀"

**解决方案**：
- 新增 `include_priority` 配置选项（默认开启）
- 当文章同时命中"包含关键词"和"排除关键词"时：
  - **开启优先级**：保留文章，标记为"被保护"
  - **关闭优先级**：按原逻辑排除
- 在结果中显示"被保护"的文章数量
- 被保护的文章会添加 `_include_protected` 标记

**使用方式**：
1. Step 2 配置规则页面，在"包含关键词"区域下方有开关
2. 默认开启："包含关键词优先于排除关键词"
3. 关闭后恢复 v1.6 的原有逻辑

### 2. 去重功能 UI 增强 (解决"找不到"问题)

**问题描述**：用户反馈"没找到去重功能，比如WOS和Scopus导出的去重"

**解决方案**：

#### 2.1 Step 1 上传后显示去重统计
- 上传文件后立即显示醒目的去重统计卡片
- 显示内容：
  - 原始导入数量
  - 去重后数量
  - 去重数量（DOI去重 + 标题去重分别统计）
- 可展开查看"去重策略说明"

#### 2.2 新增"仅去重导出"功能
- Step 1 上传后出现"仅去重导出"按钮
- 一键导出去重后的文献（不经过筛选）
- 适用于只需要跨库去重的用户
- 支持 CSV 和 Excel 格式

#### 2.3 去重详情查看
- 点击"查看去重详情"可查看被去重的具体文献
- 显示重复原因（DOI重复/标题重复）
- 支持导出去重报告

## 技术细节

### 关键词优先级实现

```javascript
// performScreening() 函数中的排除逻辑修改

// 获取是否启用包含关键词优先级
const includePriority = rules.include_priority !== false; // 默认true

// 检查是否命中包含关键词
const matchedIncludeKeyword = validKeywords.length > 0 && 
  validKeywords.some(kw => text.includes(kw.toLowerCase()));

// 排除判断逻辑
if (excluded && matchedIncludeKeyword && includePriority) {
  // 命中包含关键词且启用优先级 → 保护不排除
  row._include_protected = true;
  row._would_exclude_reason = reason;
  afterTA.push(row);
} else if (excluded) {
  // 正常排除
  excluded_ta.push({ ...row, _exclude_reason: reason });
} else {
  afterTA.push(row);
}
```

### 去重统计增强

```javascript
// 去重时记录统计信息
let dedupStats = {
  originalCount: 0,
  afterDedupCount: 0,
  doiDuplicates: 0,
  titleDuplicates: 0,
  duplicateDetails: []
};
```

## 兼容性

- 完全向后兼容 v1.6
- 默认行为改变：包含关键词优先级默认开启
- 如需恢复 v1.6 行为，关闭"包含关键词优先于排除关键词"开关即可

## 升级指南

直接替换 `app.js` 和 `index.html` 文件即可。
